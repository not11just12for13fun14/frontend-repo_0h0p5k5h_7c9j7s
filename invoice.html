<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice — flames.blue</title>
  <link rel="icon" href="assets/flames_blue_logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/css/tw-compat.css?v=f5b6f86">
  <link rel="stylesheet" href="/css/tailwind.css?v=f5b6f86">
  <link rel="stylesheet" href="/css/styles.css?v=f5b6f86">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto py-6 no-print flex items-center justify-between">
    <a href="/store.html" class="btn-ghost">Back to Store</a>
    <div class="flex items-center gap-2">
      <button id="markPaidBtn" class="btn-secondary">Mark as Paid</button>
      <button id="downloadPngBtn" class="btn-ghost">Download PNG</button>
      <button id="printBtn" class="btn-primary">Print</button>
    </div>
  </div>

  <main id="invoiceRoot" class="container mx-auto bg-white rounded-xl ring-1 ring-gray-200 invoice">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/flames_blue_logo.svg" alt="flames.blue" class="h-10"/>
        <div>
          <h2 class="text-2xl font-bold">Invoice</h2>
          <p class="text-gray-600">flames.blue</p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-gray-600">Invoice # <span id="invoiceNumber" class="font-semibold">0001</span></p>
        <p class="text-gray-600">Date: <span id="invoiceDate"></span></p>
        <p id="paidBadge" class="paid hidden">PAID</p>
      </div>
    </div>

    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="text-left text-gray-600 border-b">
            <th class="py-2 pr-4">Item</th>
            <th class="py-2 pr-4">Qty</th>
            <th class="py-2 pr-4">Price</th>
            <th class="py-2 pr-4">Total</th>
          </tr>
        </thead>
        <tbody id="invoiceItems"></tbody>
      </table>
    </div>

    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-600">
        <a id="waInvoice" class="text-[color:var(--brand-flame)]" target="_blank" rel="noopener">Share via WhatsApp</a>
        <span class="mx-2">•</span>
        <a id="emailInvoice" class="text-[color:var(--brand-flame)]">Send Email</a>
      </div>
      <div class="text-right">
        <p class="text-gray-700">Subtotal: <span id="subtotal"></span></p>
        <p class="text-gray-700">Tax (0%): <span id="tax"></span></p>
        <p class="text-lg font-semibold text-[color:var(--brand-navy)]">Grand Total: <span id="grandTotal"></span></p>
      </div>
    </div>
  </main>

  <script type="module" src="/js/main.js?v=f5b6f86"></script>
  <script>
    const fmt = (n)=>`$${n.toFixed(2)}`;
    function nextInvoiceNumber(){
      const key = 'next_invoice_number';
      let current = parseInt(localStorage.getItem(key) || '0', 10);
      if(!current || current < 1) current = 1; else current = current;
      localStorage.setItem(key, String(current+1));
      return String(current).padStart(4,'0');
    }
    const savedNumberKey = 'last_invoice_number';
    const cart = JSON.parse(localStorage.getItem('cart')||'[]');
    const invoiceNum = nextInvoiceNumber();
    localStorage.setItem(savedNumberKey, invoiceNum);
    document.getElementById('invoiceNumber').textContent = invoiceNum;
    document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString();

    const tbody = document.getElementById('invoiceItems');
    let subtotal = 0;
    cart.forEach(item=>{
      const row = document.createElement('tr');
      row.className = 'border-b last:border-0';
      const total = item.price * item.qty;
      subtotal += total;
      row.innerHTML = `<td class="py-2 pr-4">${item.title}</td>
        <td class="py-2 pr-4">${item.qty}</td>
        <td class="py-2 pr-4">${fmt(item.price)}</td>
        <td class="py-2 pr-4 font-medium">${fmt(total)}</td>`;
      tbody.appendChild(row);
    });
    document.getElementById('subtotal').textContent = fmt(subtotal);
    document.getElementById('tax').textContent = fmt(0);
    document.getElementById('grandTotal').textContent = fmt(subtotal);

    // Share links
    const summary = encodeURIComponent(`Invoice #${invoiceNum} — Total ${fmt(subtotal)}`);
    document.getElementById('waInvoice').href = `https://wa.me/?text=${summary}`;
    document.getElementById('emailInvoice').href = `mailto:billing@flames.blue?subject=Invoice%20${invoiceNum}&body=${summary}`;

    // Buttons
    document.getElementById('printBtn').onclick = ()=>window.print();
    document.getElementById('downloadPngBtn').onclick = ()=>{
      const node = document.getElementById('invoiceRoot');
      window.htmlToImage.toPng(node).then((dataUrl)=>{
        const a = document.createElement('a');
        a.href = dataUrl; a.download = `invoice-${invoiceNum}.png`; a.click();
      });
    };
    document.getElementById('markPaidBtn').onclick = ()=>{
      document.getElementById('paidBadge').classList.remove('hidden');
      localStorage.setItem('invoice_paid_'+invoiceNum, 'true');
    };
  </script>
</body>
</html>
